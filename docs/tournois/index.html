<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des tournois</title>
    <style>
        table {
            /*width: 100%;*/
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #2d669f;
            color: white;
        }

        .filter-input {
            width: 100%;
            box-sizing: border-box;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            /* Espace entre les inputs */
        }

        .date-input {
            width: 6em;
        }

        select.filter-input {
            height: 30px;
            overflow: hidden;
        }

        select.filter-input[multiple]:focus {
            /*height: auto;*/
            height: 400px;
            width: auto;
            position: absolute;
            overflow: visible;
        }

        .modal {
            display: none;
            /* Masqué par défaut */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Liste des tournois</h1>
    <table id="eventsTable">
        <thead>
            <tr>
                <th style="width:30em;">Club</th>
                <th style="width:6em;">Date</th>
                <th style="width:6em;">Date limite d'inscription</th>
                <th style="width:9em;">Catégorie</th>
                <th style="width:10em;">Niveau</th>
            </tr>
            <tr>
                <th><input type="text" id="nameFilter" class="filter-input" placeholder="Filtrer par nom"></th>
                <th>
                    <div class="filter-container">
                        <input type="text" id="dateMinFilter" class="filter-input, date-input"
                            placeholder="A partir du">
                        <input type="text" id="dateMaxFilter" class="filter-input, date-input" placeholder="Jusqu'au">
                    </div>
                </th>
                <th></th>
                <th>
                    <select id="categorieFilter" class="filter-input" multiple>
                        <option value="">Toutes les catégories</option>
                    </select>
                </th>
                <th><input type="text" id="niveauFilter" class="filter-input" placeholder="Filtrer par niveau"></th>
            </tr>
        </thead>
        <tbody>
            <!-- Les lignes du tableau seront ajoutées ici par JavaScript -->
        </tbody>
    </table>
    <!-- Modal -->
    <div id="tournoiModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Détails du Tournoi</h2>
            <div id="tournoiDetails"></div>
        </div>
    </div>

    <script>

        LINE_BACKGROUND_COLOR_ODD = '#a4d1ff';
        LINE_BACKGROUND_COLOR_EVEN = 'white';

        // Fonction pour afficher les détails du tournoi dans le modal
        function afficherDetailsTournoi(event) {
            const modal = document.getElementById("tournoiModal");
            const detailsContainer = document.getElementById("tournoiDetails");
            const tournoi = JSON.parse(event.target.dataset.tournoi);

            const categories = tournoi.categories === undefined
                ? ['Non spécifiée']
                : tournoi.categories.map(categorie => `<li>${categorie.categorie}: ${categorie.niveau}</li>`).join('');

            // Remplir les détails du tournoi
            detailsContainer.innerHTML = `
                <p>Club: ${tournoi.Club}</p>
                <p>Date: ${tournoi.Date}</p>
                <p>Date limite: ${tournoi['Date limite']}</p>
                <p>Catégories: <ul>${categories}<ul></p>
                <!-- Ajoutez d'autres détails ici -->
            `;

            // Afficher le modal
            modal.style.display = "block";
        }

        // Fermer le modal lorsque l'utilisateur clique sur le bouton de fermeture
        document.querySelector(".close").addEventListener("click", function () {
            document.getElementById("tournoiModal").style.display = "none";
        });

        // Fermer le modal lorsque l'utilisateur clique en dehors du modal
        window.addEventListener("click", function (event) {
            const modal = document.getElementById("tournoiModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        });

        document.addEventListener('DOMContentLoaded', function () {

            function creer_cellule_texte(texte) {
                const cellule = document.createElement('td');
                cellule.textContent = texte;
                return cellule;
            }
            fetch('tournois.json')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#eventsTable tbody');
                    const categorieFilter = document.getElementById('categorieFilter');
                    const categoriesSet = new Set();

                    data.forEach(tournoi => {
                        const categories = tournoi.categories === undefined ? ['Non spécifiée'] : tournoi.categories;
                        const dateLimite = tournoi['Date limite'] === undefined ? '' : tournoi['Date limite'];

                        for (categorie in categories) {
                            categoriesSet.add(categories[categorie].categorie);
                            const div_club = document.createElement('div');
                            div_club.innerHTML = tournoi.Club;
                            div_club.dataset.tournoi = JSON.stringify(tournoi);
                            div_club.addEventListener('click', function (event) {
                                afficherDetailsTournoi(event);
                            });

                            const row = document.createElement('tr');

                            const cell = document.createElement('td');
                            cell.appendChild(div_club);
                            row.appendChild(cell);

                            row.appendChild(creer_cellule_texte(tournoi.Date));
                            row.appendChild(creer_cellule_texte(dateLimite));
                            row.appendChild(creer_cellule_texte(categories[categorie].categorie));
                            row.appendChild(creer_cellule_texte(categories[categorie].niveau));

                            tableBody.appendChild(row);
                        }
                    });

                    categoriesSet.forEach(categorie => {
                        const option = document.createElement('option');
                        option.value = categorie;
                        option.textContent = categorie;
                        categorieFilter.appendChild(option);
                    });

                    const nameFilter = document.getElementById('nameFilter');
                    const dateMinFilter = document.getElementById('dateMinFilter');
                    const dateMaxFilter = document.getElementById('dateMaxFilter');
                    const niveauFilter = document.getElementById('niveauFilter');

                    function parseDate(dateString) {
                        const [day, month, year] = dateString.split('/').map(Number);
                        return new Date(year, month - 1, day);
                    }

                    function getCurrentDate() {
                        const today = new Date();
                        const day = String(today.getDate()).padStart(2, '0');
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const year = today.getFullYear();
                        return `${day}/${month}/${year}`;
                    }

                    function filterTable() {
                        console.log("Filter")
                        const nameValue = nameFilter.value.toLowerCase();
                        const dateMinValue = dateMinFilter.value.toLowerCase();
                        const dateMaxValue = dateMaxFilter.value.toLowerCase();
                        const niveauValue = niveauFilter.value.toLowerCase();
                        const selectedCategories = Array.from(categorieFilter.selectedOptions).map(option => option.value.toLowerCase());


                        const rows = tableBody.getElementsByTagName('tr');
                        nb_lines_displayed = 0;
                        for (let i = 0; i < rows.length; i++) {
                            const cells = rows[i].getElementsByTagName('td');
                            const nameText = cells[0].textContent.toLowerCase();
                            const dateText = cells[1].textContent.toLowerCase();
                            const dateLimiteText = cells[2].textContent.toLowerCase();
                            const categorieText = cells[3].textContent.toLowerCase();
                            const niveauText = cells[4].textContent.toLowerCase();

                            const dateMinCondition = dateMinValue ? parseDate(dateText) >= parseDate(dateMinValue) : true;
                            const dateMaxCondition = dateMaxValue ? parseDate(dateText) <= parseDate(dateMaxValue) : true;
                            //const dateCondition = dateValue ? new Date(dateText) <= new Date(dateValue) : true;
                            const categorieCondition = (selectedCategories.includes('') || selectedCategories.length === 0 || selectedCategories.includes(categorieText));

                            if (nameText.includes(nameValue) && dateMinCondition && dateMaxCondition && niveauText.includes(niveauValue) && categorieCondition) {
                                rows[i].style.display = '';
                                rows[i].style.backgroundColor = (nb_lines_displayed & 1 == 1) ? LINE_BACKGROUND_COLOR_ODD:LINE_BACKGROUND_COLOR_EVEN;
                                nb_lines_displayed += 1;
                            } else {
                                rows[i].style.display = 'none';
                            }
                        }
                    }

                    dateMinFilter.value = getCurrentDate();
                    filterTable();

                    nameFilter.addEventListener('input', filterTable);
                    dateMinFilter.addEventListener('input', filterTable);
                    dateMaxFilter.addEventListener('input', filterTable);
                    niveauFilter.addEventListener('input', filterTable);
                    categorieFilter.addEventListener('change', filterTable);
                })
                .catch(error => console.error('Erreur lors du chargement du fichier JSON:', error));
        });
    </script>
</body>

</html>